(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{errorEvent:()=>sn,putMetricEvent:()=>on});var n={};e.r(n),e.d(n,{reportError:()=>rn});var i={};e.r(i),e.d(i,{errorResponseInterceptor:()=>cn});var s={};e.r(s),e.d(s,{errorHandlers:()=>n,handlers:()=>t,interceptors:()=>i});var o={};e.r(o),e.d(o,{global:()=>s});var r={};e.r(r),e.d(r,{controllerInit:()=>an,frameLoadEnd:()=>dn,log:()=>un,partnerToPlugin:()=>ln,pluginRemoved:()=>hn,selectPlacements:()=>vn,setAttributesHandler:()=>gn});var c={};e.r(c),e.d(c,{closePlacement:()=>In,createPlugin:()=>yn,getPlacementDetails:()=>pn,issueSignal:()=>fn,pluginToPlugin:()=>_n,putDisplaySettings:()=>mn});const a="No Alias",d=()=>{};class u{constructor(){this._subscribers=[]}add(e){this._subscribers.push(e)}unsubscribe(){this._subscribers.forEach((e=>e.unsubscribe()))}}class l{constructor(e){this._setupFn=e}subscribe(e,t,n){const i=((e=d,t=d,n=d)=>"function"!=typeof e?e:{next:e,error:t,complete:n})(e,t,n);let s,o=!0;const r={next:e=>{o&&i.next(e)},complete:()=>{o&&(s&&s(),i.complete(),o=!1)},error:e=>{o&&(i.error(e),o=!1)}};s=this._setupFn(r),o||s&&s();const c=new u;return c.add({unsubscribe:()=>{s&&s(),o=!1}}),c}}class h{constructor(e){this.value=e,this.complete=!1,this.skip=!1}}const v=e=>(...t)=>new l((n=>{const i=e.subscribe((e=>{return i=void 0,s=void 0,r=function*(){try{let i=new h(e);for(const e of t){const t=e(i);if(i=t.then?yield t:t,!0===i.skip||!0===i.complete)break}if(i.skip)return;n.next(i.value),!0===i.complete&&n.complete()}catch(e){n.error(e)}},new((o=void 0)||(o=Promise))((function(e,t){function n(e){try{a(r.next(e))}catch(e){t(e)}}function c(e){try{a(r.throw(e))}catch(e){t(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(n,c)}a((r=r.apply(i,s||[])).next())}));var i,s,o,r}),(e=>n.error(e)),(()=>n.complete()));return()=>i.unsubscribe()})),g=e=>t=>(!1===e(t.value)&&(t.skip=!0),t),p=e=>t=>(e?!0===e(t.value)?t.complete=!0:t.skip=!0:t.complete=!0,t);function f(e=5){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=n.length;for(let s=0;s<e;s++)t+=n.charAt(Math.floor(Math.random()*i));return t}new RegExp("^\\d{4}-\\d{2}-\\d{2}((T\\d{2}:\\d{2}(:\\d{2})?)(\\.\\d{1,6})?(Z|(\\+|-)\\d{2}:\\d{2})?)?$");const m=(e=0)=>new Promise((t=>setTimeout(t,e))),y="REQUEST_TIMEOUT_ERROR";class _ extends Error{constructor(e,t){var n,i;super(e),this.name=null!==(n=null==t?void 0:t.name)&&void 0!==n?n:this.name,this.code=null==t?void 0:t.code,this.additionalInformation=null==t?void 0:t.additionalInformation,this.handled=null!==(i=null==t?void 0:t.handled)&&void 0!==i&&i}}class I{constructor(e){this.ID=e.ID,this.eventType=e.eventType,this.body=e.body||{},this.headers=e.headers||{},this.hasError=e.hasError||!1,this.isResponse=!!e.isResponse}}var S=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class w{constructor(e){var t;this.options=e,this.id=this.options.id||f(10),this.alias=this.options.alias||a,this.connection=this.options.connection,this.timeoutDuration=null!==(t=this.options.timeoutDuration)&&void 0!==t?t:1e4,this.interceptors=[]}addInterceptor(e){this.interceptors.push(e)}send(e,{body:t,headers:n={}}={}){return S(this,void 0,void 0,(function*(){const i=this.runInterceptors(this.createRequest(e,t,n)),s=new Promise(((t,n)=>S(this,void 0,void 0,(function*(){let s=!1;const o=setTimeout((()=>{s||(n(new _(`Request timed out for ${e}`,{code:y})),s=!0)}),this.timeoutDuration);v(this.connection.onMessage)(p((e=>e.ID===i.ID))).subscribe((i=>{if(s)return;if(clearTimeout(o),!i)return void n(new _(`Wrong request format for ${e}`,{code:"REQUEST_FORMAT_ERROR"}));const r=this.runInterceptors(i);!0===r.hasError?n(r.body):t(r)}))}))));return this.connection.send(i),s}))}runInterceptors(e){const t=(e=>{const t=new WeakMap,n=e=>{if(!e||"object"!=typeof e)return e;let i;const s=Array.isArray(e)?[]:{},o=Object.getPrototypeOf(s);t.set(e,s);for(const r in e)o[r]||(i=e[r],i&&"object"==typeof i?t.get(i)?s[r]=t.get(i):s[r]=n(i):s[r]=i);return s};return n(e)})(e);for(const e of this.interceptors)e(t);return t}createRequest(e,t,n){return new I({ID:f(10),eventType:e,body:t,headers:Object.assign({"sender-alias":this.alias,"sender-id":this.id},n)})}}class E extends l{constructor(){super((e=>(this._isComplete&&e.complete(),this._observers.push(e),()=>this._observers=this._observers.filter((t=>t!==e))))),this._observers=[],this._isComplete=!1}next(e){for(const t of this._observers)t.next(e)}error(e){for(const t of this._observers)t.error(e)}complete(){this._isComplete=!0;for(const e of this._observers)e.complete()}asObservable(){return new l((e=>{const t=this.subscribe(e);return()=>t.unsubscribe()}))}}const T=e=>new Promise(((t,n)=>{let i;e.subscribe((e=>i=e),(e=>n(e)),(()=>t(i)))})),R=(e,t)=>new l((n=>{const i=e=>n.next(e);return e.addEventListener(t,i),()=>e.removeEventListener(t,i)}));var P=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};const C=()=>new Promise((e=>{A()&&e(window.rokt_wsdk_debug);const t=n=>{var i,s;"ROKT_WSDK_DEBUG"===(null===(i=n.data)||void 0===i?void 0:i.from)&&"READY"===(null===(s=n.data)||void 0===s?void 0:s.type)&&e(window.rokt_wsdk_debug),window.removeEventListener("message",t)};window.addEventListener("message",t)})),A=()=>!!window.rokt_wsdk_debug,O=e=>new l((t=>{let n;return C().then((i=>{n=i[e].subscribe((e=>t.next(e)))})),()=>n&&n.unsubscribe()})),b={controller$:O("controller$"),launcher$:O("launcher$"),wsdkLifeCycle:e=>P(void 0,void 0,void 0,(function*(){(yield C()).onLifecycleEvent(e)})),sendEvent:e=>P(void 0,void 0,void 0,(function*(){(yield C()).onEvent(e)})),sendRouterConnect:e=>P(void 0,void 0,void 0,(function*(){(yield C()).onRouterConnect(e)})),sendRouterDisconnect:e=>P(void 0,void 0,void 0,(function*(){(yield C()).onRouterDisconnect(e)}))};class x{constructor(e,t,n,i){this.connection=e,this.event=t,this.routerId=n,this.routerAlias=i,this.data={},this.isSent=!1,this.responseHeaders={}}getHeaders(){return this.event.headers}getEvent(){return this.event.eventType}getContext(e){return this.data[e]}setResponseHeader(e,t){this.responseHeaders[e]=t}setContext(e,t){this.data[e]=t}getBody(){return this.event.body}setBody(e){this.event.body=e}sendError(e){this.validate(e),e instanceof Error&&(e=this.convertErrorToObject(e));const t=new I({ID:this.event.ID,eventType:this.event.eventType,body:e,headers:this.responseHeaders,hasError:!0,isResponse:!0});this.sendExtensionEvent(e,!0),this.connection.send(t),this.isSent=!0}send(e){this.validate(e);const t=new I({ID:this.event.ID,eventType:this.event.eventType,body:e,headers:this.responseHeaders,isResponse:!0});this.sendExtensionEvent(e,!0),this.connection.send(t),this.isSent=!0}hasSent(){return this.isSent}validate(e){if(!0===this.isSent)throw{name:"HandlerContext.RESPONSE_ALREADY_SENT",message:"HandlerContext: Response already sent.",code:"RESPONSE_ALREADY_SENT",additionalInformation:{response:e}}}sendExtensionEvent(e,t=!1){b.sendEvent({routerId:this.routerId,routerAlias:this.routerAlias,eventName:this.event.eventType,id:this.event.ID,headers:this.responseHeaders,body:e,hasError:t})}convertErrorToObject(e){return{message:e.message,name:e.name,stack:e.stack,code:e.code,additionalInformation:e.additionalInformation}}}var L=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class D{constructor(e){this.options=e,this.onMessage=e=>t=>{const n=new x(this.connection,t,this.id,this.alias);return b.sendEvent({routerId:this.id,routerAlias:this.alias,eventName:t.eventType,id:t.ID,body:t.body,headers:t.headers,hasError:!1}),((e,...t)=>L(void 0,void 0,void 0,(function*(){const n=e;let i=!1;const[s,o]=function(e){const t=[];return[e.filter((e=>!(e.length>1&&(t.push(e),1)))),t]}(t),r=(e,t)=>L(void 0,void 0,void 0,(function*(){if(!o.length)throw t;for(const n of o)yield n(e,t)}));for(const e of s)try{yield e(n)}catch(e){i=!0,yield r(n,e);break}i||n.hasSent()||(yield r(n,new Error(`Context: Response never sent for ${n.getEvent()}`)))})))(n,...this.middleware,...e)},this.id=this.options.id||f(10),this.connection=this.options.connection,this.alias=this.options.alias||a,this.subscription=new u,this.handlers=[],this.middleware=[],b.sendRouterConnect({id:this.id,alias:this.alias})}use(e){if(e instanceof class{constructor(){this.middleware=[],this.handlers={}}getHandlers(){const e={};for(const[t,n]of Object.entries(this.handlers))e[t]=[...this.middleware,...n];return e}use(e){this.middleware.push(e)}on(e,...t){this.handlers[e]=t}}){const t=e.getHandlers();for(const[e,n]of Object.entries(t))this.on(e,...n)}else this.middleware.push(e)}on(e,...t){if(this.handlers.includes(e))throw new Error("HandlerExists");this.handlers.push(e);const n=v(this.connection.onMessage)(g((t=>t.eventType===e)));this.subscription.add(n.subscribe(this.onMessage(t)))}close(){this.subscription.unsubscribe(),b.sendRouterDisconnect(this.id)}}var N=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class k{constructor(e,t){this.transmitter=e,this.router=t}eject(){return{transmitter:this.transmitter,router:this.router}}addInterceptor(e){return N(this,void 0,void 0,(function*(){this.transmitter.addInterceptor(e)}))}send(e,t={}){return N(this,void 0,void 0,(function*(){return this.transmitter.send(e,t)}))}use(e){return N(this,void 0,void 0,(function*(){this.router.use(e)}))}on(e,...t){return N(this,void 0,void 0,(function*(){this.router.on(e,...t)}))}close(){return N(this,void 0,void 0,(function*(){this.router.close()}))}}class G{constructor(){this.fulfilled=!1,this.rejected=!1,this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t})).then((e=>(this.fulfilled=!0,e)),(e=>{throw this.rejected=!0,e}))}isFulfilled(){return this.fulfilled}isPending(){return!this.isFulfilled()&&!this.isRejected()}isRejected(){return this.rejected}static resolve(e){const t=new G;return t.resolve(e),t}}var M=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};const U=(e,t)=>{!e.hasSent()&&t&&(e.sendError(t),((e,t)=>{e.setContext("ERROR_SENT",!0)})(e))},j="RoktRecogniser",H="CTRL_LOAD_COMPLETE",B="CONTROLLER_START",F="SELECT_PLACEMENTS_START",q="SELECT_PLACEMENTS_END",K=e=>t=>{t.isResponse||(t.headers=Object.assign(Object.assign({},t.headers),{host:e.location.host,origin:e.location.origin,href:e.location.href,pathname:e.location.pathname}))},V=e=>e.send();const W=(e,t)=>n=>{return i=void 0,s=void 0,r=function*(){try{const i=n.getHeaders(),{"sender-alias":s,"sender-id":o}=i,r=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(i=Object.getOwnPropertySymbols(e);s<i.length;s++)t.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(e,i[s])&&(n[i[s]]=e[i[s]])}return n}(i,["sender-alias","sender-id"]),c={"original-sender-alias":s,"original-sender-id":o},a=yield e.send(t||n.getEvent(),{body:n.getBody(),headers:Object.assign(Object.assign({"is-proxied":"true"},c),r)});for(const[e,t]of Object.entries(a.headers))n.setResponseHeader(e,t);n.send(a.body)}catch(e){n.sendError(e)}},new((o=void 0)||(o=Promise))((function(e,t){function n(e){try{a(r.next(e))}catch(e){t(e)}}function c(e){try{a(r.throw(e))}catch(e){t(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(n,c)}a((r=r.apply(i,s||[])).next())}));var i,s,o,r};class Y{constructor(e,t){this.type=e,this.payload=t}}const $="LINK_SENDING_DATA",X="LINK_CLIENT_READY_FOR_PORT",z="LINK_HOST_PORT_TRANSFER",J="LINK_LISTENING";class Q{constructor(e){this.port=e,this.onEvent=R(this.port,"message");const t=v(this.onEvent)(p((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.type)===J})));var n;this.onReady=T(t).then((()=>{})),this.onMessage=v(this.onEvent)(g((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.type)===$})),(n=e=>e.data.payload,e=>{const t=n(e.value);return new h(t)})),this.port.start()}send(e){this.dispatch(e)}dispatch(e){return t=this,n=void 0,s=function*(){yield this.onReady;const t=new Y($,e);this.port.postMessage(t)},new((i=void 0)||(i=Promise))((function(e,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function c(e){try{a(s.throw(e))}catch(e){o(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,c)}a((s=s.apply(t,n||[])).next())}));var t,n,i,s}}var Z=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};const ee="none";class te{constructor(e){this.window=e}getCookie(e){try{const t=this.window.document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));if(t)return t[2]}catch(e){}}setCookie(e){try{this.window.document.cookie=this.serialize(e)}catch(e){}}serialize(e){const{name:t,path:n="/",sameSite:i,secure:s,value:o}=e;let{expires:r}=e;if(!r){const e=new Date;e.setTime(e.getTime()+31536e6),r=e}let c=`${t}=${o};expires=${r.toUTCString()};path=${n}`;return s&&(c+=";secure"),i&&(c+=`;samesite=${i}`),c}}const ne=()=>{if("undefined"==typeof window)throw new Error("NO_WINDOW");return window};class ie{constructor(e){this.window=e}getItem(e){try{const t=this.window.localStorage.getItem(e);if(null===t)return;return t}catch(e){return}}setItem(e,t){try{this.window.localStorage.setItem(e,t)}catch(e){}}}var se=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class oe{constructor(e){this.options=e,this.onConnectionSubject=new E,this.connections={},this.handshakeFilter=e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.type)===X&&e.data.payload.ID===(this.options.ID||80)},this.handshake=e=>se(this,void 0,void 0,(function*(){const t=f(20),n=new this.options.channelConstructor,{port1:i,port2:s}=n,o=new Q(i);e.source&&(e.source.postMessage(new Y(z),this.options.targetOrigin,[s]),yield o.onReady,this.connections[t]=o,this.onConnectionSubject.next(o),i.postMessage(new Y(J)))})),this.onConnection=this.onConnectionSubject.asObservable();const t=R(this.options.selfEventSource,"message");this.onPostMessage=v(t)(g(this.handshakeFilter)).subscribe(this.handshake)}destroy(){this.onPostMessage.unsubscribe()}connect(e){return se(this,void 0,void 0,(function*(){const t=yield(({target:e,targetID:t=80,targetOrigin:n="*",selfEventSource:i,retryTimeout:s=1e3})=>Z(void 0,void 0,void 0,(function*(){const o=R(i,"message"),r=v(o)(p((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.type)===z}))),c=T(r);let a;setTimeout((()=>Z(void 0,void 0,void 0,(function*(){for(;void 0===a;)e.postMessage(new Y(X,{ID:t}),n),yield m(s)}))),0);const d=yield c;a=d.ports[0];const u=new Q(a);return a.postMessage(new Y(J)),u})))({target:e.target,targetOrigin:this.options.targetOrigin||"*",selfEventSource:this.options.selfEventSource});return this.onConnectionSubject.next(t),t}))}}const re=({targetOrigin:e,ID:t=80,window:n=ne()})=>new oe({targetOrigin:e,ID:t,selfEventSource:n,channelConstructor:n.MessageChannel}),ce="ROKT_FRAME_ECHO_MESSAGE";class ae{constructor(e){this.type=ce,this.name=e.name,this.id=e.id,this.origin=e.location.origin,this.host=e.location.host}}class de{constructor(e,t){this.window=e,this.validatorService=t,this.onEvent=e=>{var t;if(!this.validatorService.verify(e.origin))return;const n=e.data;(null==n?void 0:n.type)===ce&&(null===(t=e.source)||void 0===t||t.postMessage(new ae(this.window),e.origin))},this.window.addEventListener("message",this.onEvent)}remove(){this.window.removeEventListener("message",this.onEvent)}}class ue{constructor(e,t,n,i){this.headers=e,this.status=t,this.statusText=n,this.url=i}}const le="GET",he="POST";class ve{constructor(e){this.window=e}request(e){return t=this,n=void 0,s=function*(){const t=yield this.window.fetch(...(e=>{const t=e.method||"GET";return!(e.headers&&e.headers["Content-Type"])&&e.body&&"object"==typeof e.body&&(e.body=JSON.stringify(e.body),e.headers=Object.assign({"Content-Type":"application/json"},e.headers||{})),[e.url,{method:t,headers:e.headers,body:e.body}]})(e)),n=(e=>{const t={};return e.forEach(((e,n)=>t[n.toLowerCase()]=e)),t})(t.headers);if(!1===t.ok)throw new ue(n,t.status,t.statusText,t.url);const i=yield(e=>{return t=void 0,n=void 0,s=function*(){let t;return t=(e.headers.get("Content-Type")||"").includes("json")?yield e.json():yield e.text(),t},new((i=void 0)||(i=Promise))((function(e,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function c(e){try{a(s.throw(e))}catch(e){o(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,c)}a((s=s.apply(t,n||[])).next())}));var t,n,i,s})(t);return{body:i,headers:n,status:t.status,statusText:t.statusText}},new((i=void 0)||(i=Promise))((function(e,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function c(e){try{a(s.throw(e))}catch(e){o(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,c)}a((s=s.apply(t,n||[])).next())}));var t,n,i,s}get(e,t){return this.request({url:e,method:le,headers:t})}post(e,t={},n){return this.request({url:e,method:he,body:t,headers:n})}}const ge="RoktRecogniser";class pe extends class{constructor(e,t,n){this.cookieService=e,this.localStorageService=t,this.sameSite=n}setRecogniser(e){e.cookie&&this.cookieService.setCookie({name:ge,sameSite:this.sameSite,secure:!0,value:e.cookie}),e.localStorage&&this.localStorageService.setItem(ge,e.localStorage)}getRecogniser(){return{cookie:this.cookieService.getCookie(ge),localStorage:this.localStorageService.getItem(ge)}}}{constructor(e,t){super(e,t,ee)}}const fe=/^((:?\/\/|https?:)?(?:\/\/)?(?:[^/]*@)?([a-zA-z\d-\.\*]+?)(:\d{2,5})?)([/][^\?]*?)?([?].*)?$/;class me{constructor(e){this.whitelist=e}verify(e){return this.whitelist.some((t=>this._matchOrigin(t,e)))}_parseOrigin(e){const t=function(e){var t;const n=null!==(t=fe.exec(e))&&void 0!==t?t:[];return{origin:n[1],protocol:n[2],hostname:n[3],port:n[4],pathname:n[5],search:n[6]}}(null==e?void 0:e.trim().toLowerCase());if(!t||!t.hostname)return null;const{protocol:n,hostname:i,port:s}=t;return[n,i,s]}_matchHostname(e,t){if(!e||!t)return!1;const n=e.split("."),i=t.split(".");for(;n.length>0;){const e=n.pop(),t=i.pop();if("*"===e)return!0;if(e!==t)return!1}return!(i.length>0)}_matchOrigin(e,t){const n=this._parseOrigin(e),i=this._parseOrigin(t);if(null===n||null===i)return!1;const[s,o,r]=n,[c,a,d]=i;return s===c&&this._matchHostname(o,a)&&r===d}}const ye="preload",_e="[L] CLOSE_PLACEMENT",Ie="[L] FAILED_TO_LOAD_PLUGIN",Se="[L] CREATE_PLUGIN",we="PAGE_START",Ee="ROKT_START",Te="INTEGRATION_START",Re="LAUNCHER_START",Pe="PLUGIN_FRAME_CREATED",Ce="PLUGIN_RUNTIME_FRAME_CREATED",Ae="SELECTION_START",Oe="SELECTION_END",be="ERROR",xe="WARNING";class Le extends Error{constructor(e,t){var n,i;super(e),this.name=null!==(n=null==t?void 0:t.name)&&void 0!==n?n:this.name,this.code=null==t?void 0:t.code,this.additionalInformation=null==t?void 0:t.additionalInformation,this.handled=null!==(i=null==t?void 0:t.handled)&&void 0!==i&&i,this.severity=(null==t?void 0:t.severity)||be}}class De{constructor(e){var t,n,i,s,o;this.userAgent=e.navigator.userAgent,this.flocPromise=this._getFloc(e);const r=new URLSearchParams(e.name),c={initTimestamp:r.get("initTimestamp"),launcherInstanceId:r.get("launcherInstanceId"),tagId:r.get("tagId"),url:r.get("url"),sessionRecogniser:r.get("sessionRecogniser")},a=Object.keys(c).filter((e=>!c[e]&&"0"!==c[e]||"undefined"===c[e]));if(a.length)throw new Le(`Missing required parameters: ${a.join(", ")}`,{code:"CONTROLLER_CONFIGURATION",severity:be});this.initTimestamp=c.initTimestamp,this.launcherInstanceId=c.launcherInstanceId,this.tagId=c.tagId,this.url=c.url,this.sessionRecogniser=JSON.parse(c.sessionRecogniser),this.noDeviceId="true"===r.get("noDeviceId"),this.sandbox="true"===r.get("sandbox"),this.integration=null!==(t=r.get("integration"))&&void 0!==t?t:"unknown",this.integrationType=null!==(n=r.get("integrationType"))&&void 0!==n?n:"default",this.launcherVersion=null!==(i=r.get("launcherVersion"))&&void 0!==i?i:"0.0.1",this.sessionId=null!==(s=r.get("sessionId"))&&void 0!==s?s:void 0,this.serviceUrlOverride=null!==(o=r.get("serviceUrlOverride"))&&void 0!==o?o:void 0;const d=r.get("customHeaders");null!==d&&"undefined"!==d&&(this.customHeaders=JSON.parse(d))}_getFloc(e){return t=this,n=void 0,s=function*(){let t;if("function"==typeof e.document.interestCohort)try{t=yield e.document.interestCohort()}catch(e){}return t},new((i=void 0)||(i=Promise))((function(e,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function c(e){try{a(s.throw(e))}catch(e){o(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,c)}a((s=s.apply(t,n||[])).next())}));var t,n,i,s}}class Ne extends class{constructor(){this.hasConnected=!1,this.transmitter=new G,this.router=new G}setEngine(e){const{router:t,transmitter:n}=e.eject();this.router.resolve(t),this.transmitter.resolve(n),this.hasConnected=!0}setRouter(e){this.router.resolve(e)}setTransmitter(e){this.transmitter.resolve(e)}addInterceptor(e){return M(this,void 0,void 0,(function*(){(yield this.transmitter.promise).addInterceptor(e)}))}send(e,t={}){return M(this,void 0,void 0,(function*(){return(yield this.transmitter.promise).send(e,t)}))}use(e){return M(this,void 0,void 0,(function*(){(yield this.router.promise).use(e)}))}on(e,...t){return M(this,void 0,void 0,(function*(){(yield this.router.promise).on(e,...t)}))}close(){return M(this,void 0,void 0,(function*(){(yield this.router.promise).close()}))}}{}class ke{constructor(e){this._launcherConnection=e}send(e,t){return n=this,i=void 0,o=function*(){try{yield this._launcherConnection.send("[L] SEND_LAUNCHER_EVENT",{body:{name:e,payload:t}})}catch(e){}},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o}}class Ge{constructor(e,t,n){this._configSet=e,this._lifecycleRdnService=t,this._hasSignaledInit=!1,this._initTimestamp=null,this._startSelectionTimestamp=null,this._initTimestamp=new Date(n.initTimestamp)}setInitTimestamp(e){this._initTimestamp=e}onStartSelection(){this._startSelectionTimestamp=new Date}onCompleteSelection(){const e=this._configSet.getPageContext().pageInstanceGuid;e&&(this._hasSignaledInit||(this._lifecycleRdnService.pageInitialized(e,this._initTimestamp),this._hasSignaledInit=!0),this._lifecycleRdnService.pageLoadStarted(e,this._startSelectionTimestamp),this._lifecycleRdnService.pageLoadCompleted(e))}}class Me{constructor(...e){this.stores=e}add(e){this.stores.forEach((t=>t.add(e)))}}var Ue=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class je{constructor(e,t){this._metricsStore=e,this._sessionDetailsService=t,this.launcherInststanceId=new G}trigger(e){return Ue(this,void 0,void 0,(function*(){this._sessionDetailsService.getIntegrationType()!==ye&&(this.launcherInststanceId.isFulfilled()||this.launcherInststanceId.resolve(e.launcherInstanceId),this._metricsStore.add(e))}))}triggerLoadComplete(){return Ue(this,void 0,void 0,(function*(){return b.wsdkLifeCycle("CONTROLLER_READY"),this._triggerControllerEvent(H)}))}triggerControllerStart(e){return Ue(this,void 0,void 0,(function*(){return this._triggerControllerEvent(B,e)}))}triggerSelectionStart(e){return Ue(this,void 0,void 0,(function*(){return this._triggerControllerEvent(F,new Date,e)}))}triggerSelectionEnd(e){return Ue(this,void 0,void 0,(function*(){return this._triggerControllerEvent(q,new Date,e)}))}_triggerControllerEvent(e,t=new Date,n){return Ue(this,void 0,void 0,(function*(){return this.trigger({type:e,launcherInstanceId:yield this.launcherInststanceId.promise,pageInstanceId:n,timestamp:t.toISOString()})}))}}const He="PLUGIN_IS_INTERACTIVE",Be="PLUGIN_START",Fe="INTERNAL_PLUGIN_FRAME_CREATED",qe="plugin-instance-id",Ke=e=>e.getHeaders()["plugin-instance-id"];var Ve=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};const We={code:"METRICS_CALCULATION_FAILURE",severity:xe};class Ye{constructor(e,t,n){this._configSet=e,this._errorService=t,this._metricRepository=n,this._selectionEvents=new Map,this._pluginEvents=new Map,this._pluginSelectionIndex=new Map,this._pluginNameIndex=new Map}add(e){var t;return Ve(this,void 0,void 0,(function*(){const n=new Date(e.timestamp).getTime();if(e.type!==we||this._pageStart){if(e.type===Te&&!this._integrationStart)return this._integrationStart=n,void(this._integrationName=null===(t=e.data)||void 0===t?void 0:t.integrationName);if(e.type!==Re||this._launcherStart)if(e.type!==H||this._controllerLoadComplete)if(e.type===Ae&&e.pageInstanceId)this._setSelectionEvent(e.pageInstanceId,e.type,n);else if(e.type!==q)if(e.type===Oe&&e.pageInstanceId)this._setSelectionEvent(e.pageInstanceId,e.type,n);else if(e.type===Ce&&e.pluginInstanceId)this._setPluginEvent(e.pluginInstanceId,e.type,n);else if(e.type===Fe&&e.pluginInstanceId)this._setPluginEvent(e.pluginInstanceId,e.type,n);else{if(e.type!==Be||!e.pluginInstanceId)return e.type===He&&e.pluginInstanceId?(this._setPluginEvent(e.pluginInstanceId,e.type,n),void this._calculate(e.pluginInstanceId)):void 0;this._setPluginEvent(e.pluginInstanceId,e.type,n)}else for(const{pluginInstanceId:e,pageInstanceId:t,plugin:n}of this._configSet.list())this._firstSelectionId||(this._firstSelectionId=t),this._pluginNameIndex.set(e,n.name),this._pluginSelectionIndex.set(e,t);else this._controllerLoadComplete=n;else this._launcherStart=n}else this._pageStart=n}))}_setSelectionEvent(e,t,n){const i=this._selectionEvents.get(e)||new Map;i.set(t,n),this._selectionEvents.set(e,i)}_setPluginEvent(e,t,n){const i=this._pluginEvents.get(e)||new Map;i.set(t,n),this._pluginEvents.set(e,i)}_calculate(e){return Ve(this,void 0,void 0,(function*(){const t=this._pluginSelectionIndex.get(e),n=t?this._selectionEvents.get(t):void 0,i=this._pluginEvents.get(e),s=this._pluginNameIndex.get(e),o=null==n?void 0:n.get(Ae),r=null==n?void 0:n.get(Oe),c=null==i?void 0:i.get(Ce),a=null==i?void 0:i.get(Fe),d=null==i?void 0:i.get(Be),u=null==i?void 0:i.get(He);if(!(this._integrationName&&t&&this._pageStart&&this._integrationStart&&this._launcherStart&&this._controllerLoadComplete&&s&&o&&r&&c&&a&&d&&u)){const e=new Le("",We);return void this._errorService.reportError(e)}const l={timeToFirstTouch:this._integrationStart-this._pageStart,integration:this._launcherStart-this._integrationStart,framework:this._controllerLoadComplete-this._launcherStart,selection:r-o,pluginRuntime:a-c,pluginBootstrap:d-a,pluginInteractive:u-d};l.RTTI=l.integration+l.framework+l.selection+l.pluginRuntime+l.pluginInteractive+l.pluginBootstrap,l.TTI=l.RTTI+l.timeToFirstTouch,this._firstSelectionId===t&&(l.DTTI=u-this._pageStart,l.DRTTI=u-this._integrationStart);const h=[];for(const[e,t]of Object.entries(l))h.push({metricName:e,value:t,integration:this._integrationName,pluginAlias:s});yield this._metricRepository.submit(h)}))}}class $e{constructor(e){this._httpService=e}submit(e){return t=this,n=void 0,s=function*(){yield this._httpService.request({url:"/v2/metrics",method:he,body:e})},new((i=void 0)||(i=Promise))((function(e,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function c(e){try{a(s.throw(e))}catch(e){o(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,c)}a((s=s.apply(t,n||[])).next())}));var t,n,i,s}}class Xe{constructor(){this.pagesInstanceGuids={}}getPageInstanceGuid(e){return this.pagesInstanceGuids[e]||this.createEntry(e),this.pagesInstanceGuids[e].promise}setPageInstanceGuid(e,t){this.pagesInstanceGuids[e]||this.createEntry(e),this.pagesInstanceGuids[e].resolve(t)}createEntry(e){this.pagesInstanceGuids[e]=new G}}class ze{constructor(e,t,n,i,s){this._errorService=e,this._sessionDetailsService=t,this._config=n,this._windowRef=i,this._launcherConnection=s,this._data={},this._settings={},this._relations={},this._loadingTimeout=5e3}add(e,t){var n;const i=Object.assign(Object.assign({pluginInstanceId:e},t),{plugin:Object.assign(Object.assign({},t.plugin),{name:t.plugin.name||""})});i.plugin.config||(i.plugin.config={}),i.loaded=null!==(n=i.loaded)&&void 0!==n&&n,!i.plugin.name&&i.plugin.url&&(i.plugin.name=(e=>{try{return e.split("/plugins/")[1].split("/")[0]}catch(t){return"[no-alias]"+e}})(i.plugin.url)),this._data[e]=i,this._relations[e]={parentInstanceId:void 0,children:[]}}get(e){return this._data[e]}list(){return Object.values(this._data)}getPageContext(){return this._pageContext}setPageContext(e){this._pageContext=e}getDisplaySettings(e){return this._settings[e]}setDisplaySettings(e,t){this._settings[e]=t}getRelations(e){return this._relations[e]}triggerPluginLoading(e){if(this._data[e]&&!this._data[e].loaded){const t=()=>this.reportPluginLoadFailure(e);this._data[e].loadingRef=this._windowRef.setTimeout(t,this._loadingTimeout)}}triggerPluginLoaded(e){this._data[e]&&(this._data[e].loaded=!0,this._windowRef.clearTimeout(this._data[e].loadingRef))}generatePluginConfiguration(e){var t,n,i;const s=this._data[e];if(!s)throw new Error("Unknown placement");const o=new URLSearchParams;o.append("init_timestamp",(new Date).getTime().toString()),o.append("plugin_instance_id",e),o.append("launcher_instance_id",this._sessionDetailsService.getLauncherInstanceId()),o.append("rokt_tag_id",this._sessionDetailsService.getTagId()),o.append("rokt_session_id",this._sessionDetailsService.getSessionId()),o.append("page_instance_id",s.pageInstanceId),o.append("integration_type","plugin"),o.append("selection_instance_id",""),o.append("language",null!==(n=null===(t=this._pageContext)||void 0===t?void 0:t.language)&&void 0!==n?n:""),o.append("sandbox",this._config.sandbox?"true":"false");const r=null===(i=this.getRelations(e))||void 0===i?void 0:i.parentInstanceId;return r&&(o.append("parent_instance_id",r),o.append("child_plugin","true")),o.append("alias",s.plugin.id),o.toString()}reportPluginLoadFailure(e){this._errorService.reportError(new Le(`Plugin container frame failed to load within ${this._loadingTimeout}ms.`,{code:"PLUGIN_CONTAINER_LOAD",severity:be,additionalInformation:{pluginInstanceId:e}})),this._launcherConnection.send(Ie,{headers:{[qe]:e}})}}class Je{constructor(){this.connections={}}add(e,t){this.connections[e]?this.connections[e].resolve(t):this.connections[e]=G.resolve(t)}get(e){const t=this.connections[e]||new G;return this.connections[e]=t,t.promise}remove(e){const t=this.connections[e];t&&t.isPending()&&t.reject(new Error("Removed before connected")),delete this.connections[e]}}const Qe="rokt-session-id",Ze="rokt-account-id",et="rokt-third-party-cookie",tt="rokt-third-party-local-storage",nt="SignalLoadStart",it="SignalLoadComplete",st="SignalImpression";var ot=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};const rt={ERROR:"ERROR_LIMIT_EXCEEDED",WARNING:"WARNING_LIMIT_EXCEEDED"};class ct{constructor(e,t){var n;this._loggingService=t,this.limits={[be]:10,[xe]:10},this.counts={[be]:0,[xe]:0},this.limitSent={[be]:!1,[xe]:!1},null===(n=e.roktReporter)||void 0===n||n.set((e=>this._reportGlobalError(e)))}reportError(e,t=!1){return ot(this,void 0,void 0,(function*(){e.severity=e.severity||be,t||!this._checkLimit(e.severity)?yield this._loggingService.error({severity:e.severity,stackTrace:e.stack,additionalInformation:Object.assign(Object.assign({},e.additionalInformation),{message:e.message}),reporter:e.reporter,integration:e.integration,code:e.code||"UNHANDLED_EXCEPTION"}):yield this._reportLimitExceeded(e)}))}_reportGlobalError(e){return ot(this,void 0,void 0,(function*(){if(null==e?void 0:e.handled)return;const{name:t,message:n,additionalInformation:i,stack:s,code:o}=e,r={code:null!=o?o:"UNHANDLED_EXCEPTION",name:t,message:n,severity:e.severity||xe,stack:s,additionalInformation:null!=i?i:{}};try{yield this.reportError(r)}catch(e){}}))}_checkLimit(e){return!!(this.limits[e]&&(this.counts[e]+=1,this.counts[e]>this.limits[e]))}_reportLimitExceeded(e){return ot(this,void 0,void 0,(function*(){this.limitSent[e.severity]||(e.code=rt[e.severity],this.limitSent[e.severity]=!0,yield this.reportError(e,!0))}))}}const at=(e,t)=>{const n={};for(const i of Object.keys(e)){const s=e[i];t(i,s)&&(n[i]=s)}return n};var dt=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class ut{constructor(e,t,n){this._conn=e,this._transmitter=t,this._iframe=n}destroy(){var e;this._conn.destroy(),null===(e=this._iframe.parentElement)||void 0===e||e.removeChild(this._iframe)}getCookies(e){return dt(this,void 0,void 0,(function*(){return(yield this._transmitter.send("GET_COOKIE",{body:e})).body}))}setCookies(e){return dt(this,void 0,void 0,(function*(){const t={values:e};return(yield this._transmitter.send("SET_COOKIE",{body:t})).body}))}getLocalStorage(e){return dt(this,void 0,void 0,(function*(){return(yield this._transmitter.send("GET_LOCAL_STORAGE",{body:e})).body}))}setLocalStorage(e){return dt(this,void 0,void 0,(function*(){const t={values:e};return(yield this._transmitter.send("SET_LOCAL_STORAGE",{body:t})).body}))}}var lt=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class ht{constructor(e,t){this.window=e,this.constants=t}getRecogniser(){return lt(this,void 0,void 0,(function*(){try{return yield this.tryGetSession()}catch(e){return{cookie:void 0,localStorage:void 0}}}))}setRecogniser(e){return lt(this,void 0,void 0,(function*(){const t=yield this.getTransferClient(),n=[];if(e.cookie){const i=t.setCookies({[j]:{sameSite:ee,secure:!0,value:e.cookie}});n.push(i)}if(e.localStorage){const i=t.setLocalStorage({[j]:e.localStorage});n.push(i)}yield Promise.all(n)}))}destroy(){this.transferClient&&(this.transferClient.destroy(),this.transferClient=void 0)}getTransferClient(){return lt(this,void 0,void 0,(function*(){if(!this.transferClient){const n=this.constants.LEGACY_API_URL+"/session-transfer";this.transferClient=yield(e=n,t=this.window,dt(void 0,void 0,void 0,(function*(){const n=t.document.createElement("iframe");n.src=e,n.style.display="none",n.sandbox.add("allow-scripts"),n.sandbox.add("allow-same-origin");const i=new Promise((e=>n.onload=e));t.document.body.appendChild(n),yield i;const s=re({targetOrigin:"*",window:t}),o=yield s.connect({target:n.contentWindow}),r=new w({connection:o});return r.addInterceptor(K(window)),new ut(s,r,n)})))}var e,t;return this.transferClient}))}tryGetSession(){return lt(this,void 0,void 0,(function*(){const e=yield this.getTransferClient(),[t,n]=yield Promise.all([this.extractRecogniser((t=>e.getCookies(t))),this.extractRecogniser((t=>e.getLocalStorage(t)))]);return{cookie:t,localStorage:n}}))}extractRecogniser(e){return lt(this,void 0,void 0,(function*(){try{const t={keys:[j]};return(yield e(t)).RoktRecogniser}catch(e){return}}))}}function vt(e,t=3,n=100,i=(()=>!0)){return s=this,o=void 0,c=function*(){try{return yield e()}catch(e){if(t<=1||!i(e))throw e}return yield m(1*n),yield vt(e,t-1,n)},new((r=void 0)||(r=Promise))((function(e,t){function n(e){try{a(c.next(e))}catch(e){t(e)}}function i(e){try{a(c.throw(e))}catch(e){t(e)}}function a(t){var s;t.done?e(t.value):(s=t.value,s instanceof r?s:new r((function(e){e(s)}))).then(n,i)}a((c=c.apply(s,o||[])).next())}));var s,o,r,c}var gt=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class pt{constructor(e,t,n,i,s){this.window=e,this.constants=t,this.widgetApiService=n,this.sessionDetailsService=i,this.placementConfigSet=s}process(){return gt(this,void 0,void 0,(function*(){if(this.window.location.origin===this.constants.LEGACY_API_URL||this.sessionDetailsService.getNoDeviceId())return;const e=new ht(this.window,this.constants),t=yield e.getRecogniser(),n=yield this.sessionRequest(t);yield e.setRecogniser(n),e.destroy()}))}sessionRequest(e){return gt(this,void 0,void 0,(function*(){const t=this.createHeaders(e),{headers:n}=yield vt((()=>this.widgetApiService.get("/v1/session/legacy",t)));return{cookie:n["rokt-third-party-cookie"],localStorage:n["rokt-third-party-local-storage"]}}))}createHeaders({cookie:e,localStorage:t}){var n;const i=null===(n=this.placementConfigSet.getPageContext())||void 0===n?void 0:n.pageInstanceGuid;return at({[et]:e,[tt]:t,"rokt-page-instance-guid":i},((e,t)=>void 0!==t))}}var ft,mt,yt,_t,It,St,wt,Et,Tt,Rt,Pt=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};const Ct="TAG_START",At="AUTO_LAUNCHER_START",Ot="IGNORED",bt="SESSION_METRICS",xt="PLACEMENT_METRICS",Lt={[Ct]:bt,[At]:bt,[H]:bt,[B]:bt,CONTROLLER_FRAME_CREATED:bt,[we]:bt,[Ee]:bt,[Te]:Ot,[Re]:bt,[Ae]:Ot,[F]:bt,[q]:bt,[Oe]:Ot,[Pe]:xt,[Ce]:Ot,[Be]:xt,[He]:xt};class Dt{constructor(e){this.configSet=e,this.metrics={[bt]:new Nt,[xt]:{}}}add(e){var t,n;return Pt(this,void 0,void 0,(function*(){const i=Lt[e.type];let s=this.metrics.SESSION_METRICS;const o=null!==(t=e.pluginInstanceId)&&void 0!==t?t:null===(n=e.data)||void 0===n?void 0:n.pluginInstanceId;i===xt&&o&&(s=this.getPlacementMetricRecord(o)),this.setMetric(s,e)}))}getPerformanceMetrics(e){return Pt(this,void 0,void 0,(function*(){const t=this.metrics.SESSION_METRICS;if(!this.configSet.get(e))return;const n=this.getPlacementMetricRecord(e),i={autoLauncherLoadTimePerformance:yield this.getMetricComparison(t.TAG_START,t.AUTO_LAUNCHER_START),controllerLoadTimePerformance:yield this.getMetricComparison(t.LAUNCHER_START,t.CTRL_LOAD_COMPLETE),selectPlacementsTimePerformance:yield this.getMetricComparison(t.SELECT_PLACEMENTS_START,t.SELECT_PLACEMENTS_END),pluginTimeToInteractivePerformance:yield this.getMetricComparison(n.PLUGIN_FRAME_CREATED,n.PLUGIN_IS_INTERACTIVE),timeToInteractivePerformance:yield this.getMetricComparison(t.PAGE_START,n.PLUGIN_IS_INTERACTIVE),roktTimeToInteractivePerformance:yield this.getMetricComparison(t.ROKT_START,n.PLUGIN_IS_INTERACTIVE)};return Object.keys(i).reduce(((e,t)=>(null!==i[t]&&(e[t]=i[t]),e)),{})}))}getMetricComparison(e,t){return Pt(this,void 0,void 0,(function*(){const[n,i]=yield Promise.all([e.promise,t.promise]);return null===n||null===i?null:i-n}))}getPlacementMetricRecord(e){return this.metrics.PLACEMENT_METRICS[e]?this.metrics.PLACEMENT_METRICS[e]:this.metrics.PLACEMENT_METRICS[e]=new kt}setMetric(e,t){var n,i;const s=t.type;(null===(n=e[s])||void 0===n?void 0:n.isFulfilled())&&(e[s]=new G),null===(i=e[s])||void 0===i||i.resolve(new Date(t.timestamp).getTime())}}class Nt{constructor(){this[ft]=new G,this[mt]=new G,this[yt]=new G,this[_t]=new G,this[It]=new G,this[St]=new G,this[wt]=new G,this[Et]=new G,this.TAG_START.resolve(null),this.AUTO_LAUNCHER_START.resolve(null),this.PAGE_START.resolve(null),this.ROKT_START.resolve(null)}}ft=Ct,mt=At,yt=we,_t=Ee,It=Re,St=H,wt=F,Et=q;class kt{constructor(){this[Tt]=new G,this[Rt]=new G}}Tt=Pe,Rt=He;class Gt{constructor(e){this.rdnService=e}pageInitialized(e,t){this.rdnService.triggerEvent({eventType:"SignalInitialize",parentGuid:e},{clientTimeStamp:t})}pageLoadStarted(e,t){this.rdnService.triggerEvent({eventType:nt,parentGuid:e},{clientTimeStamp:t})}pageLoadCompleted(e){this.rdnService.triggerEvent({eventType:it,parentGuid:e})}placementLoadStarted(e){this.rdnService.triggerEvent({eventType:nt,parentGuid:e})}placementLoadCompleted(e){this.rdnService.triggerEvent({eventType:it,parentGuid:e})}}var Mt=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class Ut{constructor(e,t,n){this._sessionDetailsService=e,this._widgetAPIService=t,this._config=n}log(e){var t,n;return Mt(this,void 0,void 0,(function*(){if(this._sessionDetailsService.getIntegrationType()===ye)return;const i=Object.assign(Object.assign({severity:"INFO"},e),{integration:null!==(t=e.integration)&&void 0!==t?t:this._config.integration,reporter:null!==(n=e.reporter)&&void 0!==n?n:"WSDK"});yield this._widgetAPIService.request({url:"/v1/log",method:he,body:i})}))}error(e){var t,n;return Mt(this,void 0,void 0,(function*(){const i=Object.assign(Object.assign({},e),{reporter:null!==(t=e.reporter)&&void 0!==t?t:"WSDK",integration:null!==(n=e.integration)&&void 0!==n?n:this._config.integration,deviceInfo:this._sessionDetailsService.getUserAgent(),url:this._sessionDetailsService.getHref()});yield this._widgetAPIService.request({url:"/v1/errors",method:he,body:i})}))}}const jt=e=>Array.isArray(e)?e.filter(((t,n)=>e.indexOf(t)===n&&Ht(t))).join(","):Ht(e)?e.toString():"";function Ht(e){return null!=e&&""!==e}var Bt=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class Ft{constructor(e,t,n,i){this._widgetApiService=e,this._recogniserService=t,this._config=n,this._launcherEventService=i}selectPlacements(e){return Bt(this,void 0,void 0,(function*(){const t=yield this._recogniserService.getRecogniserHeaders(),n=yield this._prepareSelectPlacementsBody(e);let i;try{if(i=(yield vt((()=>this._widgetApiService.request({url:"/v2/placements",method:he,body:n,headers:t})),3,100,(e=>!(e instanceof ue)||!e.status||e.status<400||408===e.status))).body,!i.pageContext||!i.placements){const e=new Le("Unexpected placements response.");throw i.description&&i.description.match(/quota exceeded/i)&&(e.code="SANDBOX_EXCEEDED"),e}}catch(e){throw e.code||(e.code="PLACEMENTS_RESPONSE"),e.severity=xe,e}return this._launcherEventService.send("PAGE_ID_UPDATED",i.pageContext.pageId),this._launcherEventService.send("PAGE_INSTANCE_GUID_UPDATED",i.pageContext.pageInstanceGuid),this._launcherEventService.send("PAGE_VARIANT_NAME_UPDATED",i.pageContext.pageVariantName),i}))}_prepareSelectPlacementsBody(e){return Bt(this,void 0,void 0,(function*(){const t={},n=yield this._config.flocPromise;n&&(t.floc=n);for(const[n,{value:i}]of Object.entries(e.attributes)){const e=jt(i);e&&(t[n]=e)}return Object.assign(Object.assign({},e),{attributes:t})}))}}function qt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{return(("y"===e?8:0)^(t=new Uint8Array(1),(window.crypto||window.msCrypto).getRandomValues(t))[0]&15>>("y"===e?2:0)).toString(16);var t}))}var Kt=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};const Vt="RoktEtag";class Wt{constructor(e,t,n,i,s,o,r,c,a){this.apiService=e,this.recogniserAccessor=t,this.storageService=n,this.launcherConnection=i,this.errorService=s,this.window=o,this.constants=r,this.sessionDetailsService=c,this._roktEtagPromise=new G,this._etagRequestInProgress=!1,this._thirdPartyCookieKey=this.window.location.origin===this.constants.LEGACY_API_URL?et:"rokt-wsdk-third-party-cookie",this._thirdPartyLocalKey=this.window.location.origin===this.constants.LEGACY_API_URL?tt:"rokt-wsdk-third-party-local-storage",this.storeRecognisers(a.sessionRecogniser)}getSessionEtag(){return Kt(this,void 0,void 0,(function*(){if(!this.sessionDetailsService.getNoDeviceId()){if(this._etagRequestInProgress)return this._roktEtagPromise.promise;{this._etagRequestInProgress=!0;const e=this.storageService.getItem(Vt)||(yield this._requestETag());return this._roktEtagPromise.resolve(e),this._etagRequestInProgress=!1,e?(this.storageService.setItem(Vt,e),e):void 0}}}))}storeRecognisers(e){return Kt(this,void 0,void 0,(function*(){if(!this.sessionDetailsService.getNoDeviceId()){this._recognisers={firstParty:this._defaultRecognisers(e),thirdParty:this._defaultRecognisers(this.recogniserAccessor.getRecogniser())},this.recogniserAccessor.setRecogniser(this._recognisers.thirdParty);try{yield this.launcherConnection.send("[L] SET_FIRST_PARTY_RECOGNISER",{body:{firstPartyRecogniser:this._recognisers.firstParty}})}catch(e){if(e.code!==y)throw e}}}))}getRecogniserHeaders(){var e,t,n,i;return Kt(this,void 0,void 0,(function*(){if(this.sessionDetailsService.getNoDeviceId())return{"rokt-do-not-track":"true"};const s={"rokt-enable-recognition":"true","rokt-etag":yield this._roktEtagPromise.promise,"rokt-first-party-cookie":null===(e=this._recognisers)||void 0===e?void 0:e.firstParty.cookie,"rokt-first-party-local-storage":null===(t=this._recognisers)||void 0===t?void 0:t.firstParty.localStorage,[this._thirdPartyCookieKey]:null===(n=this._recognisers)||void 0===n?void 0:n.thirdParty.cookie,[this._thirdPartyLocalKey]:null===(i=this._recognisers)||void 0===i?void 0:i.thirdParty.localStorage};return at(s,((e,t)=>void 0!==t))}))}_defaultRecognisers(e={}){var t,n;return e.cookie=null!==(t=e.cookie)&&void 0!==t?t:qt(),e.localStorage=null!==(n=e.localStorage)&&void 0!==n?n:qt(),e}_requestETag(){var e,t;return Kt(this,void 0,void 0,(function*(){try{const n=yield vt((()=>this.apiService.simpleGet("/v1/session")));return(null===(e=null==n?void 0:n.headers)||void 0===e?void 0:e.Etag)||(null===(t=null==n?void 0:n.headers)||void 0===t?void 0:t.etag)}catch(e){e.code="SESSION_RESPONSE",e.severity=xe,this.errorService.reportError(e)}}))}}const Yt={[we]:"PAGE_START",[Ee]:"ROKT_START",[He]:"PLACEMENT_INTERACTIVE"};class $t{constructor(e,t,n,i){this.rdnService=e,this.pageInformationService=t,this.placementConfigSet=n,this.sessionDetailsService=i}add(e){return t=this,n=void 0,s=function*(){if(e.type!==we&&e.type!==Ee&&e.type!==He)return;const t=yield this.sessionDetailsService.getSessionIdAsync();let n;if(e.type===He){if(!e.pluginInstanceId)return;const t=this.placementConfigSet.get(e.pluginInstanceId);n=null==t?void 0:t.plugin.config.instanceGuid}else{if(!e.pageInstanceId)return;n=yield this.pageInformationService.getPageInstanceGuid(e.pageInstanceId)}n&&t&&this.rdnService.triggerMetricEvent({type:Yt[e.type],clientTimestamp:e.timestamp,instanceGuid:qt(),sessionId:t,parentInstanceGuid:n})},new((i=void 0)||(i=Promise))((function(e,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function c(e){try{a(s.throw(e))}catch(e){o(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,c)}a((s=s.apply(t,n||[])).next())}));var t,n,i,s}}const Xt=(e,t=0,n={isImmediate:!1,useAnimationFrame:!1})=>{let i;const s=!0===n.useAnimationFrame&&"function"==typeof window.requestAnimationFrame;return function(...o){const r=n.isImmediate&&!i;var c;c=()=>{i=void 0,n.isImmediate||e(...o)},i=s?(i&&window.cancelAnimationFrame(i),window.requestAnimationFrame(c)):(i&&clearTimeout(i),setTimeout(c,t)),r&&e(...o)}};class zt{constructor(e,t,n){this.widgetApiService=e,this.sessionDetailsService=t,this.errorService=n,this.scheduledEvents=[],this.scheduledMetricEvents=[],this.recordedImpressions={},this.scheduleEvent=((e,t=0,n={isImmediate:!1,useAnimationFrame:!1})=>{let i=new G;const s=Xt(((...t)=>{try{null==i||i.resolve(e(...t))}catch(e){null==i||i.reject(e)}i=new G}),t,n);return(...e)=>(s(...e),i.promise)})((()=>{const e=this.scheduledEvents.map((({eventData:e,options:t})=>this.createEventPayload(e,t)));return this.scheduledEvents=[],this.widgetApiService.post("/v1/events",e).catch((()=>this.widgetApiService.post("/v1/info",e).catch((()=>this.widgetApiService.post("/v1/responses",e).catch((e=>{throw e.code="EVENT_RESPONSE",e.severity=xe,this.errorService.reportError(e).catch((()=>{})),e})))))).then((()=>{}))}),25),this.scheduleMetricEvent=Xt((()=>{return e=this,t=void 0,i=function*(){try{const e=this.scheduledMetricEvents;this.scheduledMetricEvents=[],yield this.widgetApiService.post("/v1/events/metrics",e)}catch(e){}},new((n=void 0)||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}));var e,t,n,i}),25)}triggerEvent(e,t={clientTimeStamp:new Date}){const n={eventType:e.eventType,parentGuid:e.parentGuid,pageInstanceGuid:e.pageInstanceGuid,instanceGuid:qt(),attributes:e.attributes,objectData:e.objectData};if(e.eventType===st){if(this.recordedImpressions[e.parentGuid])return Promise.resolve();this.recordedImpressions[e.parentGuid]=!0}return this.scheduledEvents.push({eventData:n,options:t}),this.scheduleEvent()}triggerMetricEvent(e){this.scheduledMetricEvents.push(e),this.scheduleMetricEvent()}createEventPayload(e,t){var n,i;const s=null!==(i=null===(n=e.attributes)||void 0===n?void 0:n.map((e=>({name:e.name,value:e.value.toString()}))))&&void 0!==i?i:[];return Object.assign(Object.assign({},e),{attributes:s,metadata:this.createMetaData(t),sessionId:this.sessionDetailsService.getSessionId()})}createMetaData(e){var t;const n=[{name:"clientTimeStamp",value:(null!==(t=e.clientTimeStamp)&&void 0!==t?t:new Date).toISOString()},{name:"captureMethod",value:"ClientProvided"}];return e.performanceMetrics&&Object.entries(e.performanceMetrics).forEach((e=>{n.push({name:e[0],value:e[1]})})),n}}class Jt{constructor(e){this._accountId="",this._href="",this._launcherInstanceId="",this._noDeviceId=!1,this._pageIdentifier="",this._sessionId="",this._sessionIdPromise=new G,this._tagId="",this._userAgent="",this._userAgent=e.userAgent,this._launcherInstanceId=e.launcherInstanceId,this._tagId=e.tagId,this._href=e.url,this._noDeviceId=e.noDeviceId,this._integrationType=e.integrationType,e.sessionId&&this.setSessionId(e.sessionId)}getAccountId(){return this._accountId}setAccountId(e=""){return this._accountId=e}getHref(){return this._href}setHref(e){this._href=e}getIntegrationType(){return this._integrationType}getLauncherInstanceId(){return this._launcherInstanceId}setLauncherInstanceId(e){this._launcherInstanceId=e}getNoDeviceId(){return this._noDeviceId}setNoDeviceId(e){this._noDeviceId=e}getPageIdentifier(){return this._pageIdentifier}setPageIdentifier(e=""){return this._pageIdentifier=e}getSessionId(){return this._sessionId}getSessionIdAsync(){return this._sessionIdPromise.promise}setSessionId(e){return this._sessionIdPromise.resolve(e),this._sessionId=e}getTagId(){return this._tagId}setTagId(e){return this._tagId=e}getUserAgent(){return this._userAgent}setUserAgent(e){this._userAgent=e}}var Qt=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class Zt{constructor(e,t,n){this._apiService=e,this._placementConfigSet=t,this._sessionDetailsService=n,this._queuedEvents=[],this._scheduleSend=Xt((()=>Qt(this,void 0,void 0,(function*(){try{const e=this._queuedEvents;this._queuedEvents=[],yield this._apiService.simplePost("/v1/metrics",e)}catch(e){}}))),50)}add(e){return Qt(this,void 0,void 0,(function*(){let t;const n=this._sessionDetailsService.getSessionId(),i=this._placementConfigSet.getPageContext();e.pluginInstanceId&&(t=this._placementConfigSet.get(e.pluginInstanceId));const s={sessionId:n,eventName:e.type,clientTimestamp:e.timestamp,wsdkEventInstanceId:qt(),wsdkLaunchInstanceId:e.launcherInstanceId,wsdkLauncherInstanceId:e.launcherInstanceId,wsdkPageInstanceId:e.pageInstanceId,wsdkPluginAlias:e.pluginAlias,wsdkPluginInstanceId:e.pluginInstanceId,pageId:null==i?void 0:i.pageId,placementId:null==t?void 0:t.plugin.id};this._queuedEvents.push(at(s,((e,t)=>!!t))),this._scheduleSend()}))}}var en=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};class tn{constructor(e,t,n,i,s){this._httpClient=n,this._sessionDetailsService=i,this._launcherEventService=s,this._apiUrl=t.sandbox?e.SANDBOX_API_URL:e.WIDGET_API_URL,t.serviceUrlOverride&&(this._apiUrl=t.serviceUrlOverride),t.customHeaders&&(this._customHeaders=t.customHeaders)}setApiUrl(e){this._apiUrl=e}request(e){return en(this,void 0,void 0,(function*(){const t=!this._sessionDetailsService.getSessionId();e.headers=this._prepareRequestHeaders(e.headers);const n=yield this._simpleRequest(e);return t&&this._storeResponseHeaders(n.headers),n}))}post(e,t,n){return this.request({url:e,method:he,body:t,headers:n})}get(e,t){return this.request({url:e,method:le,headers:t})}simpleGet(e){return this._simpleRequest({url:e,method:le})}simplePost(e,t){return this._simpleRequest({url:e,method:he,body:t})}_simpleRequest(e){var{url:t,headers:n}=e,i=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(i=Object.getOwnPropertySymbols(e);s<i.length;s++)t.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(e,i[s])&&(n[i[s]]=e[i[s]])}return n}(e,["url","headers"]);return en(this,void 0,void 0,(function*(){return this._httpClient.request(Object.assign({url:this._apiUrl+t,headers:this._enrichWithCustomHeaders(n,this._customHeaders)},i))}))}_prepareRequestHeaders(e){const t={};return this._addHeader(Ze,this._sessionDetailsService.getAccountId(),t),this._addHeader(Qe,this._sessionDetailsService.getSessionId(),t),this._addHeader("rokt-page-identifier",this._sessionDetailsService.getPageIdentifier(),t),this._addHeader("rokt-page-url",this._sessionDetailsService.getHref(),t),this._addHeader("rokt-tag-id",this._sessionDetailsService.getTagId(),t),Object.assign(Object.assign({},t),e)}_addHeader(e,t,n){""!==t&&(n[e]=t)}_storeResponseHeaders(e){const t=e["rokt-account-id"];t&&this._sessionDetailsService.setAccountId(t);const n=e["rokt-session-id"];n&&(this._sessionDetailsService.setSessionId(n),this._launcherEventService.send("SESSION_ID_UPDATED",n))}_enrichWithCustomHeaders(e,t){return t?e?Object.assign(Object.assign({},e),t):t:e}}class nn{constructor(){var e;this.window=ne(),this.env=(()=>{let e;return void 0==={DEBUG:"false",ENVIRONMENT:"PROD",WIDGET_API_URL:"https://apps.rokt.com",SDK_ORIGIN:"https://apps.rokt.com/wsdk",SANDBOX_API_URL:"https://apps-demo.rokt.com",LEGACY_API_URL:"https://apps.rokt.com",ALTERNATE_SDK_ORIGIN:"https://wsdk.rokt.com",GLOBAL_REPORTER_PATH:"/wsdk/reporter/global-reporter.js",CONTROLLER_CSP:"default-src 'none'; script-src 'self' https://apps.rokt.com; frame-src 'self' https://apps.rokt.com; connect-src 'self' https://apps.rokt.com https://apps-demo.rokt.com; img-src 'self' data:;"}?e={DEBUG:!0,ENVIRONMENT:"LOCAL",WIDGET_API_URL:"",SDK_ORIGIN:"",SANDBOX_API_URL:"",LEGACY_API_URL:"",ALTERNATE_SDK_ORIGIN:""}:(e={DEBUG:"false",ENVIRONMENT:"PROD",WIDGET_API_URL:"https://apps.rokt.com",SDK_ORIGIN:"https://apps.rokt.com/wsdk",SANDBOX_API_URL:"https://apps-demo.rokt.com",LEGACY_API_URL:"https://apps.rokt.com",ALTERNATE_SDK_ORIGIN:"https://wsdk.rokt.com",GLOBAL_REPORTER_PATH:"/wsdk/reporter/global-reporter.js",CONTROLLER_CSP:"default-src 'none'; script-src 'self' https://apps.rokt.com; frame-src 'self' https://apps.rokt.com; connect-src 'self' https://apps.rokt.com https://apps-demo.rokt.com; img-src 'self' data:;"},e.DEBUG="true"===e.DEBUG),e.WIDGET_API_URL=e.WIDGET_API_URL||"%%WIDGET_API_URL%%",e.SDK_ORIGIN=e.SDK_ORIGIN||"%%SDK_ORIGIN%%",e.SANDBOX_API_URL=e.SANDBOX_API_URL||"%%SANDBOX_API_URL%%",e.LEGACY_API_URL=e.LEGACY_API_URL||"%%LEGACY_API_ORIGIN%%",e})(),this.config=new De(this.window),this.httpClient=new ve(this.window),this.sessionDetailsService=new Jt(this.config),this.launcherConnection=new Ne,this.launcherEventService=new ke(this.launcherConnection),this.widgetAPIService=new tn(this.env,this.config,this.httpClient,this.sessionDetailsService,this.launcherEventService),this.loggingService=new Ut(this.sessionDetailsService,this.widgetAPIService,this.config),this.errorService=new ct(this.window,this.loggingService),this.cookieService=new te(this.window),this.localStorageService=new ie(this.window),this.recogniserAccessor=new pe(this.cookieService,this.localStorageService),this.originValidator=(e=[this.env.SDK_ORIGIN,...[this.config.serviceUrlOverride].filter((e=>e))],new me(e)),this.frameFinderResponder=new de(this.window,this.originValidator),this.pageInformationService=new Xe,this.placementConnectionMap=new Je,this.placementConfigSet=new ze(this.errorService,this.sessionDetailsService,this.config,this.window,this.launcherConnection),this.recogniserService=new Wt(this.widgetAPIService,this.recogniserAccessor,this.localStorageService,this.launcherConnection,this.errorService,this.window,this.env,this.sessionDetailsService,this.config),this.legacyRecogniserService=new pt(this.window,this.env,this.widgetAPIService,this.sessionDetailsService,this.placementConfigSet),this.rdnService=new zt(this.widgetAPIService,this.sessionDetailsService,this.errorService),this.lifecycleEventService=new Gt(this.rdnService),this.placementService=new Ft(this.widgetAPIService,this.recogniserService,this.config,this.launcherEventService),this.metricRepository=new $e(this.widgetAPIService),this.rdnMetricStore=new $t(this.rdnService,this.pageInformationService,this.placementConfigSet,this.sessionDetailsService),this.wapiMetricStore=new Zt(this.widgetAPIService,this.placementConfigSet,this.sessionDetailsService),this.legacyMetricStore=new Dt(this.placementConfigSet),this.metricsStore=new Ye(this.placementConfigSet,this.errorService,this.metricRepository),this.combinedMetricStore=new Me(this.metricsStore,this.legacyMetricStore,this.rdnMetricStore,this.wapiMetricStore),this.metricsService=new je(this.combinedMetricStore,this.sessionDetailsService),this.lifecycleService=new Ge(this.placementConfigSet,this.lifecycleEventService,this.config)}}const sn=({errorService:e})=>t=>{return n=void 0,i=void 0,o=function*(){const n=t.getBody();n.severity=n.severity||n.level,yield e.reportError(n),t.send()},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o};const on=({metricsService:e})=>t=>{return n=void 0,i=void 0,o=function*(){e.trigger(t.getBody()),t.send()},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o};const rn=({errorService:e})=>(t,n)=>{return i=void 0,s=void 0,r=function*(){n&&!n.handled&&(n.handled=!0,yield e.reportError(n))},new((o=void 0)||(o=Promise))((function(e,t){function n(e){try{a(r.next(e))}catch(e){t(e)}}function c(e){try{a(r.throw(e))}catch(e){t(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(n,c)}a((r=r.apply(i,s||[])).next())}));var i,s,o,r},cn=({errorService:e})=>t=>{if(!t.isResponse||!t.hasError||t.body.handled)return;const n=t.body;n.handled=!0,e.reportError(n)};const an=({})=>e=>{return t=void 0,n=void 0,s=function*(){e.send({firstPartyRecogniser:{}})},new((i=void 0)||(i=Promise))((function(e,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function c(e){try{a(s.throw(e))}catch(e){o(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,c)}a((s=s.apply(t,n||[])).next())}));var t,n,i,s};const dn=({placementConfigSet:e})=>t=>{return n=void 0,i=void 0,o=function*(){const n=t.getBody();e.triggerPluginLoading(n.id),t.send()},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o};const un=({loggingService:e})=>t=>{return n=void 0,i=void 0,o=function*(){const n=t.getBody();yield e.log({code:n.code,additionalInformation:n.additionalInformation}),t.send()},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o};const ln=({placementConnectionMap:e})=>t=>{return n=void 0,i=void 0,o=function*(){const n=t.getHeaders()["placement-id"],i=yield e.get(n);yield W(i)(t)},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o};const hn=({})=>e=>{return t=void 0,n=void 0,s=function*(){e.send()},new((i=void 0)||(i=Promise))((function(e,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function c(e){try{a(s.throw(e))}catch(e){o(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,c)}a((s=s.apply(t,n||[])).next())}));var t,n,i,s};const vn=({pageInformationService:e,placementService:t,placementConfigSet:n,lifecycleService:i,sessionDetailsService:s,metricsService:o,recogniserService:r})=>c=>{return a=void 0,d=void 0,l=function*(){var a,d;const u=c.getBody();yield r.getSessionEtag(),o.triggerSelectionStart(u.pageInstanceId),i.onStartSelection(),s.setPageIdentifier(null!==(a=u.pageIdentifier)&&void 0!==a?a:""),u.url&&s.setHref(u.url);const l=yield t.selectPlacements(u);n.setPageContext(l.pageContext);const h=null!==(d=u.pageInstanceId)&&void 0!==d?d:qt();e.setPageInstanceGuid(h,l.pageContext.pageInstanceGuid);const v=[];for(const e of l.placements){const t=qt();n.add(t,Object.assign({pageInstanceId:h},e)),v.push({pluginInstanceId:t,alias:e.plugin.id,configuration:n.generatePluginConfiguration(t),targetElementSelector:e.plugin.targetElementSelector,targetElementRelation:e.plugin.targetElementRelation,targetElementPosition:e.plugin.targetElementPosition})}c.send({sessionId:s.getSessionId(),placements:v}),i.onCompleteSelection(),o.triggerSelectionEnd(u.pageInstanceId)},new((u=void 0)||(u=Promise))((function(e,t){function n(e){try{s(l.next(e))}catch(e){t(e)}}function i(e){try{s(l.throw(e))}catch(e){t(e)}}function s(t){var s;t.done?e(t.value):(s=t.value,s instanceof u?s:new u((function(e){e(s)}))).then(n,i)}s((l=l.apply(a,d||[])).next())}));var a,d,u,l};const gn=({sessionDetailsService:e,rdnService:t,launcherConnection:n,pageInformationService:i})=>s=>{return o=void 0,r=void 0,a=function*(){const o=s.getBody(),r=yield e.getSessionIdAsync(),c=(yield i.getPageInstanceGuid(o.pageInstanceId))||void 0,a=[];for(const[e,t]of Object.entries(o.attributes)){const n=jt(t);n&&a.push({name:e,value:n})}t.triggerEvent({eventType:"CaptureAttributes",parentGuid:r,pageInstanceGuid:c,attributes:a}).then((()=>!0)).catch((()=>!1)).then((e=>{n.send("[L] ATTRIBUTES_CAPTURE_RESULT",{body:{isSuccess:e}})})),s.send()},new((c=void 0)||(c=Promise))((function(e,t){function n(e){try{s(a.next(e))}catch(e){t(e)}}function i(e){try{s(a.throw(e))}catch(e){t(e)}}function s(t){var s;t.done?e(t.value):(s=t.value,s instanceof c?s:new c((function(e){e(s)}))).then(n,i)}s((a=a.apply(o,r||[])).next())}));var o,r,c,a};const pn=({placementConfigSet:e,pluginRuntime:t,placementConnectionMap:n})=>i=>{return s=void 0,o=void 0,c=function*(){const s=i.getBody();n.add(s.id,t),e.triggerPluginLoaded(s.id),i.send({pageContext:e.getPageContext(),placement:e.get(s.id),display:e.getDisplaySettings(s.id)})},new((r=void 0)||(r=Promise))((function(e,t){function n(e){try{a(c.next(e))}catch(e){t(e)}}function i(e){try{a(c.throw(e))}catch(e){t(e)}}function a(t){var s;t.done?e(t.value):(s=t.value,s instanceof r?s:new r((function(e){e(s)}))).then(n,i)}a((c=c.apply(s,o||[])).next())}));var s,o,r,c};const fn=({rdnService:e,legacyMetricStore:t,placementConfigSet:n})=>i=>{return s=void 0,o=void 0,c=function*(){var s;const o=i.getBody(),r=o,c={clientTimeStamp:o.overrideTimestamp?new Date(o.overrideTimestamp):void 0},a=null===(s=n.getPageContext())||void 0===s?void 0:s.pageInstanceGuid;a&&(r.pageInstanceGuid=a),r.eventType===st?(i.send(o),c.performanceMetrics=yield t.getPerformanceMetrics(o.pluginContext.pluginInstanceId),e.triggerEvent(r,c)):(e.triggerEvent(r,c),i.send(o))},new((r=void 0)||(r=Promise))((function(e,t){function n(e){try{a(c.next(e))}catch(e){t(e)}}function i(e){try{a(c.throw(e))}catch(e){t(e)}}function a(t){var s;t.done?e(t.value):(s=t.value,s instanceof r?s:new r((function(e){e(s)}))).then(n,i)}a((c=c.apply(s,o||[])).next())}));var s,o,r,c};const mn=({placementConfigSet:e})=>t=>{return n=void 0,i=void 0,o=function*(){const n=t.getBody();e.setDisplaySettings(Ke(t),n)},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o};const yn=({placementConfigSet:e,launcherConnection:t})=>n=>{return i=void 0,s=void 0,r=function*(){const{config:i,parentInstanceId:s,url:o,name:r,configurables:c,fonts:a}=n.getBody(),d=qt(),u=e.get(s);if(!u)throw new Le(`CreatePlugin: Failed to create. No parent instance config found for ${s}.`,{code:"CREATE_CHILD_PLUGIN"});e.add(d,{plugin:{id:"",url:o,name:r,config:i},placementConfigurables:c||u.placementConfigurables,fonts:a||u.fonts,pageInstanceId:u.pageInstanceId}),e.getRelations(d).parentInstanceId=s,e.getRelations(s).children.push(d),n.send({pluginInstanceId:d});const l=e.generatePluginConfiguration(d);yield t.send(Se,{body:{pluginInstanceId:d,parentInstanceId:s,configuration:l}})},new((o=void 0)||(o=Promise))((function(e,t){function n(e){try{a(r.next(e))}catch(e){t(e)}}function c(e){try{a(r.throw(e))}catch(e){t(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(n,c)}a((r=r.apply(i,s||[])).next())}));var i,s,o,r};const _n=({placementConnectionMap:e})=>t=>{return n=void 0,i=void 0,o=function*(){const{to:n}=t.getBody(),i=yield e.get(n);yield i.send("[P] PLUGIN_TO_PLUGIN_INBOUND",{body:t.getBody()}),t.send()},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o};const In=({placementConfigSet:e,placementConnectionMap:t,launcherConnection:n})=>i=>{return s=void 0,o=void 0,c=function*(){const{pluginInstanceId:s}=i.getBody(),o=Ke(i),r=s||o,c=e.getRelations(r);if(c){const i=[];for(const e of c.children)i.push(n.send(_e,{headers:{[qe]:e}}));if(yield Promise.all(i),void 0!==c.parentInstanceId){const n=yield t.get(c.parentInstanceId);yield n.send("[P] PLUGIN_IS_CLOSING",{body:{pluginInstanceId:r}});const i=e.getRelations(c.parentInstanceId);i.children=i.children.filter((e=>e!==r))}}i.send(),yield n.send(_e,{headers:{[qe]:r}})},new((r=void 0)||(r=Promise))((function(e,t){function n(e){try{a(c.next(e))}catch(e){t(e)}}function i(e){try{a(c.throw(e))}catch(e){t(e)}}function a(t){var s;t.done?e(t.value):(s=t.value,s instanceof r?s:new r((function(e){e(s)}))).then(n,i)}a((c=c.apply(s,o||[])).next())}));var s,o,r,c};var Sn=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};const wn=(e,t,n)=>Sn(void 0,void 0,void 0,(function*(){t.launcherConnection.setEngine(e),function(e,t){e.on("[C] CONTROLLER_INIT",an(t)),e.on("[C] SELECT_PLACEMENTS",vn(t)),e.on("[C] FRAME_LOAD_END",dn(t)),e.on("[P] PARTNER_TO_PLUGIN",ln(t)),e.on("[C] PLUGIN_REMOVED",hn(t)),e.on("[C] PUT_INFO",V),e.on("[C] LOG",un(t)),e.on("[C] SET_ATTRIBUTES",gn(t))}(e,t),yield n,yield t.metricsService.triggerLoadComplete(),yield e.send("[L] CONTROLLER_SETUP_COMPLETE"),t.window.setTimeout((()=>Sn(void 0,void 0,void 0,(function*(){try{yield function(e,t){return n=this,i=void 0,o=function*(){const n=yield t.sessionDetailsService.getSessionIdAsync();if(n)try{yield e.send("[L] SET_SESSION_ID",{body:{sessionId:n}})}catch(e){if(e.code!==y)throw e}},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o}(e,t)}catch(e){t.errorService.reportError(e)}}))),0),t.window.setTimeout((()=>Sn(void 0,void 0,void 0,(function*(){try{yield(o=t.sessionDetailsService,r=t.legacyRecogniserService,e=void 0,n=void 0,i=void 0,s=function*(){yield o.getSessionIdAsync(),yield r.process()},new(i||(i=Promise))((function(t,o){function r(e){try{a(s.next(e))}catch(e){o(e)}}function c(e){try{a(s.throw(e))}catch(e){o(e)}}function a(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,c)}a((s=s.apply(e,n||[])).next())})))}catch(e){t.errorService.reportError(e)}var e,n,i,s,o,r}))),0),t.window.setTimeout((()=>{!function(e,t){var n,i,s,o;n=this,i=void 0,o=function*(){if(!(Math.random()>.2))try{yield e.log({code:"LAUNCHER_VERSION",additionalInformation:{version:t.launcherVersion}})}catch(e){}},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}))}(t.loggingService,t.config)}),3e3)}));var En=function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{a(i.next(e))}catch(e){o(e)}}function c(e){try{a(i.throw(e))}catch(e){o(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}a((i=i.apply(e,t||[])).next())}))};const Tn=new Date;!function(){En(this,void 0,void 0,(function*(){const e=new nn;e.metricsService.triggerControllerStart(Tn);const t=e.recogniserService.getSessionEtag();re({targetOrigin:"*"}).onConnection.subscribe((n=>En(this,void 0,void 0,(function*(){const i=new k(new w(s={connection:n,alias:"Controller"}),new D(s));var s;i.use(rn(e)),i.use(U),i.use((e=>t=>{t.setResponseHeader("origin",e.location.origin),t.setResponseHeader("host",e.location.host),t.setResponseHeader("href",e.location.href),t.setResponseHeader("pathname",e.location.pathname)})(e.window)),i.addInterceptor(K(e.window)),i.addInterceptor(cn(e)),i.on("[C] PUT_METRIC_EVENT",on(e)),i.on("[C] ERROR",sn(e)),!1===e.launcherConnection.hasConnected?yield wn(i,e,t):yield function(e,t){return n=this,i=void 0,o=function*(){e.on("[C] GET_PLACEMENT_DETAILS",pn(Object.assign(Object.assign({},t),{pluginRuntime:e}))),e.on("[C] ISSUE_SIGNAL",fn(t)),e.on(_e,In(t)),e.on("[L] PLUGIN_TO_PARTNER",W(t.launcherConnection)),e.on("[C] PLUGIN_TO_PLUGIN_OUTBOUND",_n(t)),e.on("[L] GET_FULFILLMENT_ATTRIBUTES",W(t.launcherConnection)),e.on(Ie,W(t.launcherConnection)),e.on("[L] PLUGIN_RESIZED",W(t.launcherConnection)),e.on("[L] PUT_DISPLAY_SETTINGS",mn(t),W(t.launcherConnection)),e.on("[C] CREATE_PLUGIN",yn(t))},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o}(i,e)})))),(e=>{!1!==e.env.DEBUG&&(((e,t)=>{const n=ne();void 0===n[e]&&(n[e]={}),((e,t)=>{ne()[e]=t})(e,Object.assign(Object.assign({},n[e]),t))})("ROKT_DEBUG",{services:e,generalHandlers:o,launcherHandlers:r,pluginRuntimeHandlers:c}),b.controller$.subscribe((t=>{return n=void 0,i=void 0,o=function*(){if("CREATE_PLUGIN"===t.type){const n=t.data,{fonts:i,configurables:s}=n,o=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(i=Object.getOwnPropertySymbols(e);s<i.length;s++)t.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(e,i[s])&&(n[i[s]]=e[i[s]])}return n}(n,["fonts","configurables"]);e.placementConfigSet.getPageContext()||e.placementConfigSet.setPageContext({roktTagId:"roktTagId",pageId:"pageId",pageInstanceGuid:"pageInstanceGuid",language:"en"});const r=f(10);e.placementConfigSet.add(r,{plugin:Object.assign({id:r},o),placementConfigurables:s,fonts:i,pageInstanceId:""}),yield e.launcherConnection.send(Se,{body:{pluginInstanceId:r,alias:r,targetElementSelector:o.targetElementSelector,configuration:e.placementConfigSet.generatePluginConfiguration(r)}})}},new((s=void 0)||(s=Promise))((function(e,t){function r(e){try{a(o.next(e))}catch(e){t(e)}}function c(e){try{a(o.throw(e))}catch(e){t(e)}}function a(t){var n;t.done?e(t.value):(n=t.value,n instanceof s?n:new s((function(e){e(n)}))).then(r,c)}a((o=o.apply(n,i||[])).next())}));var n,i,s,o})))})(e)}))}()})();